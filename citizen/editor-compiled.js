!function(e,t,n,i){"use strict";let o=TypechoCore.state("citizenRoot");function r(e="",t){return[o+"carol/carolEditor.js",o+"daryl/darylEditor.js",o+"carol/carol.js","/common/themes/citizen/assets/carol/config-compiled.js?v="+e,t?"https://registry.npmmirror.com/typecho-core/citizen/files/carol/carolExtends.min.js":""]}let a={".cm-cursor":{borderLeftColor:"var(--color-base--subtle)"},".cm-gutters":{color:"var(--color-base--subtle)",backgroundColor:"var(--color-surface-3)",border:"none",transition:"var(--transition-background)"},".cm-activeLine":{backgroundColor:"var(--background-color-quiet--hover)"},".cm-activeLineGutter":{transition:"var(--transition-background)",backgroundColor:"var(--color-surface-4)"},".cm-tooltip":{border:"none",backgroundColor:"var(--color-surface-3)"},".cm-selectionBackground":{backgroundColor:"var(--color-surface-3) !important"}};TypechoCore.Callback.EditorDraft=function(e,t){if(e.success){if(e.draftId){let i=n.getElementById("cid");i&&(n.getElementById("cid").value=e.draftId)}if(e.time){let o=n.getElementById("statusTips"),r=n.getElementById("draftNotice"),a=n.createElement("p"),s="当前正在编辑的是未发布的草稿，最后一次保存于：<b>"+e.time+"</b>。";if(!o)return;r?r.innerHTML=s:(a.classList.add("edit-draft-notice"),a.id="draftNotice",a.innerHTML=s,TypechoCore.ui.setupHtmlInsert(o,a,0,!1))}}},TypechoCore.Element.classicEditor=async function(t){let i=t.closest(".editor-container"),o=t.data("version"),s=!!t.data("external-smiley"),c=e('<span class="editor-inspector is-loading">正在加载工作区。</span>');c.appendTo(i);let l=r(o,s);await TypechoCore.engine.requestResource(l),Carol.setCodeMirrorThemeConfig(a),Carol.init(t[0],function(i){let o=i.ui.view.toolbar.element;t.before(e(o)),c.removeClassTransitioned("is-loading",function(){c.remove()}),TypechoCore.utils.bindKey(function(){if(""===n.getElementById("title").value)return TypechoCore.ui.flashMessage("应至少提供一个标题，才能执行快速保存。");n.getElementById("save").click()},e=>(e.ctrlKey||e.metaKey)&&83===e.which)},{removePlugins:["ActionButton"]}),TypechoCore.xhr.listenOnce(Carol.destroy,"click")},TypechoCore.Element.instantEditor=function(t){let i=n.getElementById(t.data("editor")),o=t.data("version"),s=!!i.getAttribute("data-external-smiley"),c=t.data("typecho-security-tk"),l=t.data("cid"),d=e(".p-cover"),u=function(n){let i=e(n.ui.view.toolbar.element),o=t.closest(".container").addClass("instant-editor");TypechoCore.ui.setupHtmlInsert(o,i,0,!1,"editor-toolbar"),TypechoCore.utils.bindKey(function(){n.execute("commitSubmit")},e=>(e.ctrlKey||e.metaKey)&&83===e.which),TypechoCore.utils.disableHistoryOnce(),t.remove()};t.on("click",function(){d&&d.css("opacity",.5),t.html('<div class="loading"></div>处理中').off("click");let e=n.getElementById("comments");e||(e=n.querySelector('[data-typecho-init="discussion"]')),e&&(e.title="快速编辑模式。所有评论功能已禁用。");let m=r(o,s);TypechoCore.engine.requestResource(m).then(e=>{TypechoCore.xhr.makeRequest({type:"POST",url:"/action/contents-post-edit",data:{do:"fastPublish",_:c,cid:l,preheat:l},async success(e){d&&d.remove(),Carol.setContentId(l),Carol.setSecurityToken(c),Carol.setCodeMirrorThemeConfig(a),i.innerHTML=TypechoCore.content.html;let t=e.draft;if(t&&t.parent){let n=t.cid,o=t.text,r=t.modified,s=new Date(1e3*r),m="此文章包含草稿。草稿保存于 "+s.toLocaleTimeString()+"。编辑它的草稿，还是编辑当前已经发布的此文章本身？";await TypechoCore.ui.dialog("检测到草稿",m,[{text:"编辑草稿",callback:function e(){i.innerHTML=o,Carol.setContentId(n)}},{text:"编辑已发布文章",type:"primary"}],!1)}Carol.init(i,u),TypechoCore.xhr.listenOnce(Carol.destroy)}})})})},TypechoCore.Element.commentEditorCarol=function(t,n,i,o,a,s,c){t.on("click",function(){e(this).html('<div class="loading"></div>处理中').off("click"),s.appendTo(i);let l=r(o,a);TypechoCore.engine.requestResource(l).then(function(){Carol.init(n,e=>{c(e,t,n,s)},{placeholder:null,removePlugins:["ActionButton","Heading","Template","Table","FormatPainter","HtmlEmbed","Image","ImageInsertUrlUIHack","LinkImage","MediaEmbed","MediaEmbedToolbar"],toolbar:{items:["undo","redo","bold","italic","underline","strikethrough","fontSize","fontColor","style","link","code","blockQuote","codeBlock",{label:"段落控制",items:["alignment","numberedList","bulletedList","todoList","outdent","indent"]},"smiley","accessibilityHelp"]}})})})},TypechoCore.Element.sourceEditor=async function(t){function n(e){DarylEditor.create(e[0],a,e.data("language"))}await TypechoCore.engine.requestResource(o+"daryl/darylEditor.js"),t.is("textarea")?n(t):t.find("textarea[data-language]").each(function(){n(e(this))}),TypechoCore.xhr.listenOnce(DarylEditor.destroy,"click")},TypechoCore.Element.writerHelper=function(t){let n=e("select[name = visibility]");function i(t){let n=t.val(),i=e(".p-password");"password"===n?i.removeClass("hidden"):i.addClass("hidden")}i(n),n.change(function(){i(n)})},TypechoCore.Element.timePicker=async function(t){if(await TypechoCore.engine.requestResource(["https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-y/jqueryui/1.12.1/jquery-ui.min.js","https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-y/jquery.mask/1.14.16/jquery.mask.min.js","https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-y/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.js","https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.css"]),void 0===e.fn.datetimepicker||void 0===e.fn.mask){console.error("jQuery DateTimePicker 或 Mask 未加载。");return}t.mask("9999-99-99 99:99").datetimepicker({currentText:"现在",prevText:"上一月",nextText:"下一月",monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],dayNames:["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],dayNamesShort:["周日","周一","周二","周三","周四","周五","周六"],dayNamesMin:["日","一","二","三","四","五","六"],closeText:"完成",timeOnlyTitle:"选择时间",timeText:"时间",hourText:"时",amNames:["上午","A"],pmNames:["下午","P"],minuteText:"分",secondText:"秒",dateFormat:"yy-mm-dd",timezone:t.data("timezone")/60,hour:new Date().getHours(),minute:new Date().getMinutes()}),TypechoCore.xhr.listenOnce(()=>{e(".ui-datepicker").remove()})},TypechoCore.Element.tagsHelper=async function(t){if(await TypechoCore.engine.requestResource(["https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-y/jquery-tokeninput/1.7.0/jquery.tokeninput.min.js",]),void 0===e.fn.tokenInput)return console.error("jQuery TokenInput 未加载。");let n=e("[data-tags-info]").data("tags-info"),i=t.data("tag-class"),o=[],r="p-token--dropdown",a=t.val().split(",");for(let s=0;s<a.length;s++){let c=a[s];c&&o.push({id:c,tags:c})}t.tokenInput(n,{allowFreeTagging:!0,allowTabOut:!0,propertyToSearch:"tags",tokenValue:"tags",searchingText:"处理中...",searchDelay:200,preventDuplicates:!0,hintText:"请输入标签名。",noResultsText:"此标签不存在，回车即可创建。",prePopulate:o,animateDropdown:!1,classes:{token:"p-token",selectedToken:"p-token--selected",tokenDelete:"p-token--delete",tokenList:"p-token--list u-inputWidget-input",inputToken:"p-token--input",focused:"p-token--focused",dropdown:r,dropdownItem:"p-token--dropdownItem",dropdownItem2:"p-token--dropdownItemB",selectedDropdownItem:"p-token--dropdownSelected"},onResult:function(e,t,n){return t?(e||(e=[]),e[0]&&e[0].id===t||e.unshift({id:n,tags:n}),e.slice(0,5)):e}}),e("."+i).on("click",function(){let n=e(this).text();t.tokenInput("add",{id:n,tags:n})}),TypechoCore.xhr.listenOnce(function(){t.tokenInput("destroy"),e("."+r).remove()})},TypechoCore.registerElement("source-editor"),TypechoCore.registerElement("classic-editor"),TypechoCore.registerElement("instant-editor"),TypechoCore.registerElement("writer-helper"),TypechoCore.registerElement("tags-helper"),TypechoCore.registerElement("time-picker")}(jQuery,window,document);