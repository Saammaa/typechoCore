let TypechoCore=window.TypechoCore||{};(TypechoCore={initialized:!1,initRegistry:[],proxyRegistry:[],backendAssetsPath:"",kernelOrigin:"",resolvedRequests:[],mainContainerId:"main",pjaxTargetSelectors:[],debugMode:!1,captchaProvider:null,init:function(){if(void 0===window.jQuery)return console.error("jQuery 未加载，请先加载 jQuery。");if(this.initialized)return console.error("TypechoCore 被重复加载。");for(let e in this)null!==this[e]&&"object"==typeof this[e]&&(this[e]._core=this);this.State.init(),$(document).trigger("core:preInit"),this.kernelOrigin=this.getScriptOrigin(),this.backendAssetsPath=this.getRelativePath(),this.registerElement("page-title"),this.registerElement("captcha"),this.registerElement("instant-toc"),this.registerElement("instant-overlay"),this.registerElement("ajax-submit"),this.registerJQExtends(),this.engine.postRequireResourceFromDOM(),this.xhr.listen(this.utils.lazyLoad,!0),this.xhr.listen(this.content.getInfoFromAnywhere,!0),this.xhr.listen(this.elementInit),this.utils.addPjaxTarget('a:not(a[target="_blank"])'),$(document).pjax(this.pjaxTargetSelectors.join(", "),{timeout:this.xhr.timeout,container:"#"+this.mainContainerId,fragment:"#"+this.mainContainerId}),$(document).trigger("core:postInit"),this.initialized=!0},state:function(e,t){if(!t)return this.State[e];this.State[e]=t},proxy:function(e,t,n){let i=e+"."+t;if(this.proxyRegistry.includes(i)||"function"!=typeof n)return;let o=e[t];Object.defineProperty(e,t,{get:()=>o,set(e){o=e,n(e)},enumerable:!0,configurable:!0}),this.proxyRegistry.push(i)},elementInit:function(e,t){let n="[data-typecho-init"+(e?"="+e:"")+"]",i=t&&t.length?t.find(n):$(n);i.each(function(){if($(this).data("initialized"))return!0;let e=$(this).data("typecho-init")??"",t=TypechoCore.initRegistry[e];try{let n=TypechoCore.Element[t];"function"==typeof n&&($(this).data("initialized",!0),n($(this)))}catch(i){console.warn("触发器 "+e+" 出现了内部问题。",i)}}),$(document).trigger("core:elementReady")},registerElement:function(e,t=null,n=!0){this.initRegistry[e]&&console.warn("注册器在 "+e+" 上有声明重复。这不符合注册规范。请检查其明确性。"),this.initRegistry[e]=t||e.replace(/-([a-z])/g,function(e,t){return t.toUpperCase()}),n&&this.elementInit(e)},isElementRegistered:function(e){return this.initRegistry.hasOwnProperty(e)},xhr:{makeRequest:$.ajax,makePopStateRequest:$.pjax,lastFormResponse:null,timeout:8e3,listen:function(e,t=!1,n="end"){"function"==typeof e&&($(document).on("pjax:"+n,function(){e.bind(null)()}),t&&e())},listenOnce:function(e,t="beforeReplace"){"function"==typeof e&&$(document).one("pjax:"+t,function(){e.bind(null)()})}},utils:{getCssTransitionDuration:null,scrollTo:function(e){e instanceof jQuery&&(e=e[0]),e instanceof HTMLElement&&e.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},lazyLoad:function(e,t=".lazy",n="fadeIn",i=300,o=!0){if(void 0===$.lazy)return;e instanceof HTMLElement||(e=e instanceof jQuery?e[0]:document.getElementById(e??TypechoCore.mainContainerId));let r=TypechoCore.kernelOrigin+TypechoCore.backendAssetsPath;$(e).find(t).Lazy({effect:n,effectTime:i,visibleOnly:o,defaultImage:r+"loading.svg",afterLoad:function(e){e.addClass("lazy-loaded")}})},bindKey:function(e,t,n=!1){"function"!=typeof e||"function"!=typeof t||($(document).on("keydown",i),n||this._core.xhr.listenOnce(function(){$(document).off("keydown",i)}));function i(n){if(t(n))return n.preventDefault()||e(),!1}},disableHistoryOnce:function(e=!1){if($.pjax.defaults.replace=!0,e){let t=Math.floor(16777215*Math.random()).toString(16).padEnd(6,"0");window.history.replaceState(null,null,window.location.href.split("?")[0]+"?_t="+t)}$(document).one("core:elementReady",()=>{$.pjax.defaults.replace=!1})},addPjaxTarget:function(e){this._core.pjaxTargetSelectors.push(e)}},engine:{requestNew:function(e,t){"function"==typeof t&&t(t=>{t&&t(),this._core.resolvedRequests.push(e)},this._core.resolvedRequests.includes(e))},requestResource:async function(e){for(let t of($(document).trigger("core:promisedLoadStart"),Array.isArray(e)||(e=[e]),e)){if(!t||""===t)continue;let n=t.split("/").pop().split("?")[0];await new Promise((e,i)=>{this._core.engine.requestNew(n,function(i,o){if(o)e();else if(n.endsWith(".js"))$.getScript(t).done(function(){i(e)});else if(n.endsWith(".css")){let r=$("<link>").prop("href",t).prop("type","text/css").prop("rel","stylesheet").on("load",function(){i(e)});$("head").append(r)}})})}$(document).trigger("core:promisedLoadStart")},isResolved:function(e){return this._core.resolvedRequests.includes(e)},postRequireResourceFromDOM(){let e=$("[data-require]");e.each(function(){let e=$(this).data("require");TypechoCore.engine.requestResource(e).then()})},handleServerResponse:function(e){let t=e.message;if(this._core.xhr.lastFormResponse=e,t&&this._core.ui.flashMessage(t,2e3),null!==e.action){let n=e.redirect;switch(e.action){case"goBack":window.history.go(-1);break;case"refresh":this._core.engine.instantRedirect();break;case"tough":!function e(n,i=2e3){function o(){n?location.href=n:location.reload()}t?setTimeout(o,i):o()}(n,e.delay)}}e.redirect&&this._core.engine.instantRedirect(e.redirect),$(document).trigger(e.success?"core:xhrPositive":"core:xhrNegative")},instantRedirect:function(e=null,t=null){let n=e??window.location.href,i=325,o=this._core.ui.overlay;o&&(i=this._core.utils.getCssTransitionDuration(o),this._core.ui.destoryOverlay()),setTimeout(()=>{$.pjax({url:n,container:t??"#"+this._core.mainContainerId,timeout:this._core.xhr.timeout,fragment:t??"#"+this._core.mainContainerId})},i)}},ui:{overlay:null,flashMessage:function(e,t=1250,n=null){let i=$('<div class="flashMessage"><div class="flashMessage-content"></div></div>');i.find(".flashMessage-content").html(e),i.appendTo("body"),i.addClassTransitioned("is-active"),setTimeout(function(){i.removeClassTransitioned("is-active",function(){i.remove(),n&&n()})},Math.max(500,t))},setupHtmlInsert:function(e,t,n,i=!1,o="",r=280,a="easeOutCubic",s){let l=t instanceof jQuery?t:$(t),c=e instanceof jQuery?e:$(e);switch(n){case -1:c.before(l);break;case 0:c.prepend(l);break;default:c.append(l)}i&&l[0].scrollIntoView();let u=l.outerHeight(!0);return l.css("max-height",0).css("overflow-y","clip").animate({maxHeight:u},r,a).addClass(o),setTimeout(function(){l.css("max-height","unset").css("overflow","inherit")},r+10),this._core.elementInit(null,l),"function"==typeof s&&s(),l},getOverlayHtml:function(e,t,n=""){let i;if("string"==typeof e)i=$($.parseHTML(e));else if(e instanceof $)i=e;else throw Error("只能使用作为字符串或 jQuery 对象提供的 HTML 创建 Overlay。");if(!i.is(".overlay")){if(!t){let o=i.find(".overlay-title");o.length&&(t=o.contents(),o.remove())}t||(t=$("title").text());let r=i.find(".overlay-content");r.length&&(i=r);let a=$('<div class="overlay" tabindex="-1"><div class="overlay-title"></div><div class="overlay-content"></div></div>'),s=a.find(".overlay-title");s.html(t),a.find(".overlay-content").html(i),i=a.addClass(n)}return i.appendTo("body"),i},createOverlay:function(e,t=!0){let n=$('<div class="overlay-container" />').html(e);n.on("mousedown",function(e){let t=$(this);t.data("block-close",!1),$(e.target).is(t)||t.data("block-close",!0)}),n.on("click",function(e){let n=$(this);$(e.target).is(n)&&t&&!n.data("block-close")&&TypechoCore.ui.destoryOverlay(),n.data("block-close",!1)}),$("body").addClass("is-modalOpen"),n.appendTo("body").addClassTransitioned("is-active"),this.overlay=n},destoryOverlay:function(){let e=this.overlay;e&&e.removeClassTransitioned("is-active",function(){$("body").removeClass("is-modalOpen"),e.remove()}),this.overlay=null},dialog:function(e,t,n,i=!0){return new Promise((o,r)=>{let a=$('<div class="p-dialog--message"></div>'),s=$('<div class="p-dialog--action"></div>');$.each(n,function(e,t){void 0===t.destoryOnClick&&(t.destoryOnClick=!0),t.type&&void 0!==t.type||(t.type="default");let n=$("<button></button>").text(t.text).on("click",()=>{let e=t.callback;"function"==typeof e&&e(),t.destoryOnClick&&TypechoCore.ui.destoryOverlay(),o(t)}).addClass("p-button p-button--"+t.type);s.append(n)}),a.html(t);let l=this.getOverlayHtml(a.add(s),e,"overlay-dialog");this.createOverlay(l,i)})},switchable:function(e,t,n="u-hidden"){e.on("click",function(e){t.toggleClass(n),e.stopPropagation()});let i=i=>{t.is(i.target)||e.is(i.target)||0!==t.has(i.target).length||t.addClass(n)};$(document).on("click",i),TypechoCore.xhr.listenOnce(function(){$(document).off("click",i)})}},storage:{localStorageArray:function(e,t=null){let n=JSON.parse(localStorage.getItem(e));if(!t)return n;n||(n=[]),n.push(t),localStorage.setItem(e,JSON.stringify(n))},localStorageArrayExists:function(e,t){let n=this.localStorageArray(e);return n&&n.includes(t)}},content:{id:null,areaId:"contentArea",html:null,permalink:"",registerArea:function(e=null){e?TypechoCore.content.areaId=e:e=TypechoCore.content.areaId;let t=document.getElementById(e);TypechoCore.content.html=t?t.innerHTML:null},getInfoFromAnywhere:function(){let e=document.querySelector("[data-permalink]"),t=document.querySelector("[data-cid]");TypechoCore.content.id=t?t.dataset.cid:null,TypechoCore.content.permalink=e?e.dataset.permalink:null}},registerJQExtends:function(){function e(e){let t=e[0];if(!t||!(t instanceof window.Element))return 0;let n=e.css("transition-duration"),i=0;if(n){let o=n.match(/^(\+|-|)([0-9]*\.[0-9]+|[0-9]+)(ms|s)$/i);if(o){let r="-"===o[1]?-1:1,a=parseFloat(o[2]),s="ms"===o[3].toLowerCase()?1:1e3;i=r*a*s}}return i}this.utils.getCssTransitionDuration=e,$.fn.addClassTransitioned=function(t,n){let i=$(this),o=e(i);return setTimeout(function(){i.addClass(t)},16.5),"function"==typeof n&&setTimeout(n,16.5+o),this},$.fn.removeClassTransitioned=function(t,n){let i=e($(this));return $(this).removeClass(t),"function"==typeof n&&setTimeout(n,i),this},$.fn.classTo=function(e,t){$(this).removeClass(e).addClass(t)},$.extend($.easing,{def:"easeOutQuad",easeOutCubic:function(e){return 1-Math.pow(1-e,3)},easeOutQuart:function(e){return 1-Math.pow(1-e,4)}})},getRelativePath:function(e=null){let t=e??document.currentScript.src,n=new URL(t),i=n.pathname,o=t.substring(t.lastIndexOf("/")+1);return i.replace(o,"")},getScriptOrigin:function(){let e=new URL(document.currentScript.src);return e.origin},Processor:{},Callback:{},State:{loadedFrom:"browser",init:function(){TypechoCore.xhr.listen(()=>{TypechoCore.State.loadedFrom="xhrClick"},!1,"click"),TypechoCore.xhr.listen(()=>{TypechoCore.State.loadedFrom="popstate"},!1,"popstate")},isLoadedForm:function(e=null){return e?this.loadedFrom===e:this.loadedFrom}},Element:{pageTitle:function(e){document.title=e.text()},instantToc:function(e){let t=e.data("selector")??"toc-list";(function e(t){let n=document.querySelector(t?"."+t:".toc-list");if(n){let i=n.querySelectorAll("a"),o=window.location.href;i.forEach(function(e){e.href===o?(e.classList.add("is-active"),e.parentNode.classList.add("is-active-li")):(e.classList.remove("is-active"),e.parentNode.classList.remove("is-active-li"))})}})(t)},ajaxSubmit:function(e){e.data("trustedSubmitter",!0);let t=e.closest("form"),n=t.attr("action")??window.location.href,i=t.attr("method"),o=e.data("html-response"),r=e.attr("rel"),a=e.attr("name"),s=e.data("callback"),l=e.data("preprocess"),c=e.attr("value");function u(e){let t=e.serializeArray(),n={};return $.each(t,function(e,t){n[t.name]=t.value}),n}function d(){let r=e.closest("form");if(l)try{r=TypechoCore.Processor[l](r)}catch(a){r=e.closest("form"),console.warn("XHR 表单提交的预处理行为 "+l+" 出现错误。",a)}TypechoCore.xhr.makeRequest({url:n,type:i,data:r.serialize(),success(i){!function i(r){if("string"==typeof r){let a=o?n+"?"+e.closest("form").serialize():n;TypechoCore.engine.instantRedirect(a);return}if(s)try{TypechoCore.Callback[s](r,u(t))}catch(l){console.warn("XHR 表单提交回调 "+s+" 出现错误。",l)}TypechoCore.engine.handleServerResponse(r)}(i)},error:function(e,t,n){console.error("服务器未能返回预期数据。",t,n)}})}a?n+=(-1!==n.indexOf("?")?"&":"?")+a+"="+c:e.attr("href")&&(n=e.attr("href")),r&&(n=r),this.getNonceFormData=u,e.on("click",function(e){e.preventDefault(),d()}),t.on("submit",function(e){e.preventDefault();let t=document.activeElement;if(t&&!$(t).data("trustedSubmitter"))return console.warn("表单中有元素尝试触发提交，但被拒绝了。",t),!1;d()})},instantOverlay:function(e){let t=e.attr("href"),n=e.data("fragment"),i=e.data("secure"),o=e.data("auto-close"),r=e.attr("title");t&&e.on("click",function(e){e.preventDefault(),e.stopPropagation(),$.get(t,{proxy:!!i},function(e){e=$("<div>").append(e).find(n??"form");let t=TypechoCore.ui.getOverlayHtml(e,r);TypechoCore.ui.createOverlay(t),o&&$(document).one("core:xhrPositive",()=>{TypechoCore.ui.destoryOverlay()}),TypechoCore.elementInit(null,t)})})},captcha:function(e){let t=e.data("provider")??"grecaptcha",n;function i(){n.reset()}n=window[t],this.captchaProvider=n,$(document).on("core:xhrNegative",null,null,i),TypechoCore.xhr.listenOnce(function(){$(document).off("core:xhrNegative",null,i)},"click")}}}).init();